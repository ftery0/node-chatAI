<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama Chat AI</title>
     <style>
    /* 기본 리셋 */
    *{margin:0;padding:0;box-sizing:border-box}
    html,body,#root{height:100%}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background: linear-gradient(135deg,#4f46e5 0%, #243455 100%);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      gap:24px;
      /* 전체 배경에 약한 노이즈/그라디언트 */
    }

    /* 배경 글라스(앱을 돋보이게) */
    .app-shell {
      position:fixed;
      inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      backdrop-filter: blur(8px) saturate(120%);
      -webkit-backdrop-filter: blur(8px) saturate(120%);
      z-index:-1;
    }

    /* 전체 화면 컨테이너 */
    .chat-container {
      width: 100%;
      height: 100%;
      max-width: 1400px; /* 원하는 최대 폭 */
      max-height: 100vh;
      margin: auto;
      display:flex;
      flex-direction:column;
      border-radius:18px;
      overflow:hidden;
      /* 글라스 카드 스타일 */
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 10px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      padding: 0;
    }

    /* 헤더 */
    .chat-header{
      padding:20px 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    
    .chat-header h1{ font-size:1.2rem; color:#fff; display:flex;align-items:center; gap:10px}
    .status{ font-size:0.9rem; opacity:0.95}
    .connection-status{
      width:12px;height:12px;border-radius:50%;
      background:#ef4444; transition:background .3s;
      box-shadow:0 0 8px rgba(0,0,0,0.4);
    }
    .connection-status.connected{ background:#10b981; box-shadow:0 0 12px rgba(16,185,129,0.25);}
    .status-initializing {
    color: #fff; /* 초기 상태 흰색 */
}

.status-error {
    color: #ef4444; /* 오류 시 빨간색 */
}

.status-ready {
    color: #bde8da; /* 준비 완료 시 초록색 (선택) */
}
    .chat-header button {
  padding: 8px 16px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(79, 70, 229, 0.08); /* 프라이머리 투명 */
  color: #fff;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

/* 로그인 버튼 (프라이머리 강조) */
#loginBtn {
  background: linear-gradient(135deg, #4f46e5, #4338ca);
  border: none;
}
#loginBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(79, 70, 229, 0.45);
}

/* 로그아웃 버튼 (투명한 글라스 느낌) */
#logoutBtn {
  background: rgba(255,255,255,0.06);
}
#logoutBtn:hover {
  background: rgba(255,255,255,0.12);
  transform: translateY(-2px);
}

    /* 레이아웃: 좌측 사이드바, 우측 채팅 (flex-grow) */
    .layout{
      display:flex;
      flex:1;
      min-height:0;
    }

    .sidebar{
      width:320px;
      padding:16px;
      border-right:1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
    }
    .sidebar-header{ display:flex; gap:8px; align-items:center }
    .sidebar button{ padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:#fff; cursor:pointer}

    .room-list{ overflow:auto; padding-right:6px; flex:1 }
    .room-item{ margin-bottom:10px; padding:12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.02); color:#e6eef8; cursor:pointer}
    .room-item:hover{ transform:translateY(-2px) }

    .chat-pane{ flex:1; display:flex; flex-direction:column; min-width:0; }
    .chat-messages{
      flex:1;
      overflow:auto;
      padding:28px;
      display:flex;
      flex-direction:column;
      gap:14px;
      background: linear-gradient(180deg, rgba(6,8,15,0.0), rgba(6,8,15,0.02));
      scrollbar-width: thin;
    }

    .message{ max-width:75%; }
    .message.user{ align-self:flex-end; text-align:right }
    .message.ai{ align-self:flex-start; text-align:left }

    .message-content{
      display:inline-block;
      padding:14px 18px;
      border-radius:18px;
      font-size:0.98rem;
      line-height:1.4;
      word-break:break-word;
      box-shadow: 0 6px 18px rgba(2,6,23,0.5);
    }
    .message.user .message-content{
      background: linear-gradient(135deg,#667eea,#764ba2);
      color:white;
    }
    .message.ai .message-content{
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.86));
      color:#0b1220;
      border:1px solid rgba(11,18,32,0.06);
    }

    .message-time{ font-size:0.75rem; color:rgba(255,255,255,0.6); margin-top:6px }

    .chat-input{
      padding:18px;
      display:flex;
      gap:12px;
      align-items:center;
      border-top:1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0));
    }
    .input-group{ display:flex; gap:12px; flex:1 }
    #messageInput{ flex:1; padding:12px 16px; border-radius:999px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:#fff; outline:none }
    #sendButton{ padding:10px 18px; border-radius:999px; background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; border:none; cursor:pointer }

    /* 반응형: 모바일에서는 사이드 숨김 */
    @media (max-width:900px){
      .sidebar{ display:none; }
      .chat-container{ border-radius:12px; }
      #messageInput{ font-size:0.95rem }
      .message-content{ max-width:85%; }
    }
  </style>
</head>
<body>
  <div class="app-shell" aria-hidden="true"></div>

  <div class="chat-container" role="application" aria-label="Llama Chat">
    <header class="chat-header">
      <div style="display:flex;align-items:center;gap:12px">
        <div id="connectionStatus" class="connection-status" aria-hidden="true"></div>
        <h1>🦙 Llama Chat AI</h1>
        <div style="margin-left:10px" class="status-initializing" id="statusText">AI 시스템 초기화 중...</div>
      </div>

      <div style="display:flex;align-items:center;gap:8px">
        <span id="meText" style="color:#e6eef8">로그인 필요</span>
        <button id="loginBtn">로그인</button>
        <button id="logoutBtn" style="display:none">로그아웃</button>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <button id="newRoomBtn">+ 새 채팅</button>
          <button id="reloadRoomsBtn">새로고침</button>
        </div>
        <div id="roomList" class="room-list"></div>
      </aside>

      <main class="chat-pane">
        <div id="chatMessages" class="chat-messages">
          <div class="message ai">
            <div class="message-content">안녕하세요! 로컬 Llama AI와 대화해보세요. 무엇을 도와드릴까요?</div>
            <div class="message-time" id="initialTime"></div>
          </div>
        </div>

        <div class="chat-input">
          <div class="input-group">
            <input id="messageInput" type="text" placeholder="메시지를 입력하세요..." disabled />
            <button id="sendButton" disabled>전송</button>
          </div>
        </div>
      </main>
    </div>
  </div>

    <script>
        class ChatClient {
            constructor() {
                this.ws = null;
                this.sessionId = this.generateUUID();
                this.isConnected = false;
                this.messageBuffer = '';
                this.currentUser = null;
                this.currentRoomId = null;
                
                this.initializeElements();
                this.connect();
                this.setupEventListeners();
                this.updateInitialTime();
                this.bootstrapAuthAndRooms();
            }

            initializeElements() {
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.chatMessages = document.getElementById('chatMessages');
                this.statusText = document.getElementById('statusText');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.meText = document.getElementById('meText');
                this.loginBtn = document.getElementById('loginBtn');
                this.logoutBtn = document.getElementById('logoutBtn');
                this.roomList = document.getElementById('roomList');
                this.newRoomBtn = document.getElementById('newRoomBtn');
                this.reloadRoomsBtn = document.getElementById('reloadRoomsBtn');
            }

            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            connect() {
                const wsPort = window.location.port ? (parseInt(window.location.port) + 1) : 3001;
                const wsUrl = `ws://${window.location.hostname}:${wsPort}`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket 연결됨');
                    this.isConnected = true;
                    this.connectionStatus.classList.add('connected');
                    
                    // 세션 생성
                    this.sendMessage({
                        type: 'session_create',
                        sessionId: this.sessionId
                    });
                };

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                };

                this.ws.onclose = () => {
                    console.log('WebSocket 연결 종료');
                    this.isConnected = false;
                    this.connectionStatus.classList.remove('connected');
                    this.updateStatus('연결이 끊어졌습니다. 재연결 시도 중...', 'error');
                    
                    // 3초 후 재연결 시도
                    setTimeout(() => this.connect(), 3000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket 오류:', error);
                    this.updateStatus('연결 오류가 발생했습니다.', 'error');
                };
            }

            handleMessage(data) {
                switch (data.type) {
                    case 'status':
                        if (data.content.includes('ready')) {
                            this.updateStatus('AI 시스템이 사용가능!', 'ready');
                            this.enableInput();
                        } else {
                            this.updateStatus(data.content, 'initializing');
                        }
                        break;
                        
                    case 'session_created':
                        console.log(`세션 생성됨: ${data.sessionId}`);
                        break;
                        
                    case 'chunk':
                        this.messageBuffer += data.content;
                        this.updateTypingMessage(this.messageBuffer);
                        break;
                        
                    case 'message':
                        if (data.isComplete) {
                            this.hideTyping();
                            this.addMessage('ai', data.content, data.timestamp);
                            this.messageBuffer = '';
                            this.enableInput();

                            if (this.currentUser && this.currentRoomId) {
                                this.apiSaveAssistantMessage(this.currentRoomId, data.content).catch(() => {});
                            }
                        }
                        break;
                        
                    case 'error':
                        this.hideTyping();
                        this.addMessage('ai', `오류: ${data.error}`, data.timestamp);
                        this.enableInput();
                        break;
                        
                    case 'pong':
                        console.log('Pong received');
                        break;
                }
            }

            sendMessage(message) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                }
            }

            sendUserMessage() {
                const message = this.messageInput.value.trim();
                if (!message || !this.isConnected) return;

                this.addMessage('user', message);
                this.messageInput.value = '';
                this.disableInput();
                this.showTyping();

                if (this.currentUser && this.currentRoomId) {
                    this.apiSaveUserMessage(this.currentRoomId, message).catch(() => {});
                }

                this.sendMessage({
                    type: 'message',
                    sessionId: this.sessionId,
                    content: message,
                    timestamp: new Date().toISOString()
                });
            }

            addMessage(type, content, timestamp) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;

                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = this.formatTime(timestamp || new Date().toISOString());

                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(timeDiv);
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            showTyping() {
                this.typingIndicator.classList.add('show');
                this.scrollToBottom();
            }

            hideTyping() {
                this.typingIndicator.classList.remove('show');
                this.clearTypingMessage();
            }

            updateTypingMessage(content) {
                let typingMessage = document.getElementById('typingMessage');
                if (!typingMessage) {
                    typingMessage = document.createElement('div');
                    typingMessage.id = 'typingMessage';
                    typingMessage.className = 'message ai';
                    typingMessage.innerHTML = `
                        <div class="message-content" id="typingContent"></div>
                        <div class="message-time">입력 중...</div>
                    `;
                    this.chatMessages.appendChild(typingMessage);
                }

                const typingContent = document.getElementById('typingContent');
                typingContent.textContent = content;
                this.scrollToBottom();
            }

            clearTypingMessage() {
                const typingMessage = document.getElementById('typingMessage');
                if (typingMessage) {
                    typingMessage.remove();
                }
            }

            enableInput() {
                this.messageInput.disabled = false;
                this.sendButton.disabled = false;
                this.messageInput.focus();
            }

            disableInput() {
                this.messageInput.disabled = true;
                this.sendButton.disabled = true;
            }

            updateStatus(text, status) {
                this.statusText.textContent = text;
                this.statusText.classList.remove('status-initializing', 'status-error', 'status-ready');

                // 상태에 따라 클래스 추가
                switch(status) {
                    case 'initializing':
                        this.statusText.classList.add('status-initializing');
                        break;
                    case 'error':
                        this.statusText.classList.add('status-error');
                        break;
                    case 'ready':
                        this.statusText.classList.add('status-ready');
                        break;
                }
            }

            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }

            updateInitialTime() {
                const initialTimeElement = document.getElementById('initialTime');
                initialTimeElement.textContent = this.formatTime(new Date().toISOString());
            }

            setupEventListeners() {
                this.sendButton.addEventListener('click', () => {
                    this.sendUserMessage();
                });

                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendUserMessage();
                    }
                });

                // Keep connection alive with ping
                setInterval(() => {
                    if (this.isConnected) {
                        this.sendMessage({ type: 'ping' });
                    }
                }, 30000);

                this.loginBtn.addEventListener('click', () => {
                    window.location.href = '/login.html';
                });


                this.logoutBtn.addEventListener('click', async () => {
                    await this.apiLogout();
                    await this.refreshMe();
                    this.roomList.innerHTML = '';
                    this.currentRoomId = null;
                });

                this.newRoomBtn.addEventListener('click', async () => {
                    if (!this.currentUser) {
                        alert('로그인 후 사용 가능합니다');
                        return;
                    }
                    const name = prompt('채팅방 이름 (선택)') || '';
                    const room = await this.apiCreateRoom(name);
                    if (room) {
                        await this.loadRooms(room.id);
                    }
                });

                this.reloadRoomsBtn.addEventListener('click', async () => {
                    await this.loadRooms(this.currentRoomId || undefined);
                });
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            new ChatClient();
        });
    </script>
</body>
</html>